name: ZMK Build (Sofle)

on:
  push:
  pull_request:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    strategy:
      fail-fast: false
      matrix:
        include:
          - board: nice_nano_v2
            shield: sofle_left
          - board: nice_nano_v2
            shield: sofle_right

    steps:
      # 1️⃣ Checkout
      - name: Checkout
        uses: actions/checkout@v4

      # 2️⃣ 使用 Python 3.11（關鍵，避免 distutils 問題）
      - name: Setup Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      # 3️⃣ 安裝系統依賴（ZMK / Zephyr 官方可用）
      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            git cmake ninja-build gperf \
            device-tree-compiler \
            gcc-arm-none-eabi \
            python3-dev python3-pip

      # 4️⃣ 安裝 west
      - name: Install west
        run: |
          python -m pip install --upgrade pip
          pip install west

      # 5️⃣ 初始化 Zephyr / ZMK
      - name: West init
        run: west init -l config

      - name: West update
        run: west update

      - name: West zephyr-export
        run: west zephyr-export

      # 6️⃣ Build（Sofle 左 / 右）
      - name: Build ${{ matrix.shield }}
        run: |
          west build -s zmk/app \
            -b ${{ matrix.board }} \
            -- -DSHIELD=${{ matrix.shield }} \
               -DZMK_CONFIG=${GITHUB_WORKSPACE}/config

      # 7️⃣ 收集產物
      - name: Prepare artifacts
        run: |
          mkdir -p artifacts
          if [ -f build/zephyr/zmk.uf2 ]; then
            cp build/zephyr/zmk.uf2 artifacts/${{ matrix.shield }}-${{ matrix.board }}.uf2
          fi
          if [ -f build/zephyr/zmk.hex ]; then
            cp build/zephyr/zmk.hex artifacts/${{ matrix.shield }}-${{ matrix.board }}.hex
          fi

      # 8️⃣ 上傳 firmware
      - name: Upload firmware
        uses: actions/upload-artifact@v4
        with:
          name: firmware-${{ matrix.shield }}
          path: artifacts
